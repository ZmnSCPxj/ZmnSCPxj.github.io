<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Proof-of-mainstake</title>
</head>
<body>

<div class=header>
<p><a href='../../index.html'>ZmnSCPxj</a> &raquo; <a href='../index.html'>Sidechain</a> &raquo; Proof-of-mainstake</p>
</div>

<div class=content>
<h1>Background</h1>
<p>In <a href='http://www.drivechain.info/'>Drivechains</a>, miners
are paid for the validity of sidechain blocks, but are supposed to
guess the validity of sidechain withdrawals; this mechanism is
supposed to ensure that miners do not have to run sidechain nodes,
but the guessing game of sidechain withdrawal validity undermines
its security, and miners are obligated to run sidechain nodes anyway,
increasing the barrier-to-entry of new miners.  See this
<a href=' https://www.reddit.com/r/Bitcoin/comments/6ztp3b/lets_discuss_something_techrelated_for_a_change/dmy7jgu/'>Reddit thread</a>.</p>
<p>Another proposal (mine, <a href='../driveproof/index.html'>Driveproof, or
Sidechain Headers On Mainchain (SHOM)</a>), unifies voting with
merge mining, and then lets miners be paid for both validity of
sidechain blocks and validity of sidechain withdrawals.  This
lets the set of sidechain "miners" be completely disjoint from
the set of mainchain miners.  It has
the drawback that in the stable state, sidechain "miners" pay
almost all of their sidecoin earnings to mainchain miners,
the sidechain's total fees have to approach or exceed the rate
limit imposed on side-to-main withdrawals (to prevent theft),
and thus sidechain "miners" must use up all the limited
side-to-main bandwidth to replenish their maincoin stock to
be able to continue paying mainchain miners, vastly weakening
the peg.</p>
<p>Hence, I present here proof-of-mainstake.</p>

<h1>Introduction</h1>
<p>Proof-of-mainstake is a sidechain proposal similar to a
federated peg, with the federation membership determined by a
stake of coins on the mainchain (i.e. the mainstake).  As the
name suggests, it is similar to proof-of-stake in that staked
coins are used to indicate a controlling interest.</p>
<p>At a glance, the mechanism is:</p>
<ul>
 <li>A maincoin owner dedicates an amount of maincoin as stake
     to a particular sidechain (note that this is
     <em>separate</em> from the maincoin that is backing the
     sidecoin).</li>
 <li>At each new mainchain block, we run a stake lottery
     (as is usual for proof-of-stake).  The seed of the RNG
     used for that lottery is the mainchain block header
     hash of the previous block.  The tickets in the lottery
     are those UTXO's that were staked to the sidechain as
     of the latest block.</li>
 <li>The winning sidechain staker assembles a candidate
     sidechain block (with fees paid to himself or herself),
     signs it, and bribes miners to include
     the sidechain block header on the mainchain.</li>
 <li>Miners may only include one sidechain block header from
     the winning sidechain staker.</li>
 <li>Mainchain fullnodes validate mainchain blocks by ensuring
     that an included sidechain block header is signed by the
     stake lottery winner (which it determines from the previous
     block hash in the mainchain header, and the UTXO set as of
     the previous block hash) and that a sidechain
     block header (if it exists) commits to some previous
     sidechain block header hash (as in sidechain headers on
     mainchain).</li>
 <li>As in Driveproof/SHOM, side-to-main withdrawals are valid if
     the withdrawal transaction on the sidechain is on the longest
     chain of the sidechain, the longest chain dominates in length
     over all the other chains of the sidechain, and the
     withdrawal is deep enough.  The length of a chain is a vote
     for the validity of a withdrawal on that chain.</li>
</ul>
<p>This must be strongly emphasized: <strong><em>The mainchain
coins in a mainstake are a separate set of coins from the
coins locked into the sidechain.</em></strong></p>

<h1>Nothing-at-stake and Stake-grinding</h1>
<p>Proof-of-stake is unsafe as a consensus algorithm due to
the nothing-at-stake and stake-grinding problems.</p>
<ul>
 <li><dfn>Nothing-at-stake</dfn> is the problem where a stake
     winner can sign multiple different versions of the block
     they won, showing different blocks to different
     peers.  A <dfn>long-range nothing-at-stake</dfn> is the
     problem where a stake winner wins a block, spends all the
     staked coins, then reverses history by signing a different
     version of the previously-won block and regaining their
     coins.</li>
 <li><dfn>Stake-grinding</dfn> is the problem where the stake
     winner generates several candidate blocks.  The stake
     winner does not publish blocks until it gets a block that
     would cause the stake lottery to go to the stake winner
     again.</li>
</ul>
<p>Combining nothing-at-stake and stake-grinding lets a stake
owner who wins once create a true chain and a cheating chain.
The stake owner publishes the true chain and spends money for
real services on that chain.  In the meantime, it continuously
grinds stake on an alternate, cheating chain, keeping itself
the winner of the lottery on the cheating chain.
When it receives the real services, it publishes the cheating
chain if it is longer, reversing the spend of its money.</p>
<p>Here is how proof-of-mainstake avoids these classic
problems:</p>
<ul>
 <li>A stake winner may sign multiple sidechain blocks, but
     only one of those will be committed to on the mainchain.
     In order to perform a long-range nothing-at-stake attack,
     the sidechain operator needs to have significant
     mainchain hashpower to reverse the mainchain and build a
     longer chain.</li>
 <li>In order to perform a stake-grinding attack, the stake
     winner needs to target two desiderata: grind the stake so
     that it will win again, <em>and</em> grind the
     proof-of-work on the mainchain.  It also cannot grind the
     stake indefinitely, as other mainchain miners are also
     grinding with their only target being simply
     proof-of-work.</li>
</ul>
<p>In effect, nothing-at-stake is avoided by publishing
checkpoints on the mainchain, and using mainchain consensus
to commit to the checkpoints.  Stake-grinding is avoided by
reusing the mainblock header hash as the lottery seed for the
next mainblock; any stake-grinding attempt needs to also target
the current difficulty on the mainchain, increasing the
effective difficulty a stake-grinder needs to target.</p>
<p>In many ways, proof-of-mainstake is not the same as
proof-of-stake.</p>

<h1>Building Sidechain Headers</h1>
<p>SPV proof publication and merge mining is done via the same
mechanism; the stake lottery winner publishes a sidechain block
header, paying miners to include the sidechain block header
on the mainchain.
Hence, mainstake is also a sidechain-headers-on-mainchain system.</p>
<p>Sidechain block headers are reduced down to two core
fields:</p>
<ol>
 <li><code>hashMerkleRoot</code>, 32 bytes that commit to the
     sideblock's transactions and any extra data the sidechain
     needs to operate.</li>
 <li><code>hashPrevBlock</code>, 32 bytes that are the hash of
     the previous sidechain block header.</li>
</ol>
<p>For each sidechain ID, for each mainchain block, at most
one sidechain block header may be published.  In addition, the
sidechain block header may be published only by the stake
lottery winner.</p>
<p>Sidechain block headers are generally expected to continue
the sidechain's topmost tip, but they may, at the stake winner's
discretion, continue an earlier sidechain block header.  This
means that the stake winner was either unable to verify the
tipmost sidechain block header, or that sidechain block header
had invalid transactions.</p>
<p>The mainchain itself is unable to directly confirm that the
committed sidechain headers commit to valid blocks; it uses
the merge mining process itself as an SPV proof.  Since the
headers are visible on the mainchain, any mainchain node can
judge the validity of any side-to-main withdrawal at SPV
security.</p>

<h1>Side-to-main Withdrawal</h1>
<p>Side-to-main withdrawals are done by publishing a withdrawal
transaction on the sidechain, and having some sidechain block
header commit to the withdrawal transaction.  On the mainchain
itself, spends of the sidechain's lockbox require that a
withdrawal transaction:</p>
<ol>
 <li>is on the longest chain of the sidechain</li>
 <li>is at least N sidechain blocks deep</li>
 <li>is on all other chains of the sidechain that are at most
     N sidechain blocks behind the longest chain (i.e. it must
     exist on every competing chain of the sidechain that is
     0 to N sidechain blocks behind the longest chain in
     height).</li>
</ol>
<p>Since the sidechain header is published on mainchain, a
mainchain fullnode can determine the length of each of the
sidechain's split chains, and uses the length as a proxy for
validity, on the assumption that rational sidechain stakers
would rather cooperatively build the sidechain rather than
steal the sidechain's backing maincoin.</p>
<p>Obviously the format of the sidechain withdrawal transaction
should be something that the mainchain nodes can understand.
However, for normal, intra-sidechain transactions, the sidechain
may adopt an incompatible transaction format.  This can be done
by putting the withdrawal transaction in a special branch of the
transaction Merkle tree of the sidechain, and putting the
actual sidechain transaction Merkle tree in the other branch of
that node.</p>
<p>Lockboxes of a sidechain may be created and spent, but
may normally only be spent to other lockboxes of the same
sidechain.  To pay from a sidechain lockbox to some mainchain
P2SH addess, then a proof that a side-to-main withdrawal exists
on the sidechain at some sidechain block header must be provided.
In addition, the mainchain must confirm that this withdrawal has
not been used before; the easiest way to implement this is to
simply allow one withdrawal per sidechain block and to keep track
of sidechain block headers already used in mainchain-side
withdrawals in a constantly-growing set.  Imposing limits &mdash;
such as requiring that withdrawals on the mainchain side can only
refer to sidechain block headers at most 12,960 mainchain blocks
(about 3 months) ago &mdash; can be used to allow pruning of this
set, at the cost that in case of extremely persistent sidechain
chainsplits, withdrawals may become lost (sidechains could keep
track of whether withdrawals are unclaimed on mainchain and let
the withdrawals be re-spent in the sidechain if this is
problematic).</p>

<h1>Mainstaking</h1>
<p>Let us sketch out the details of mainstake a little.  We
add a new opcode, <code>OP_STAKEVERIFY</code>, from an existing
<code>OP_NOP</code>.  Then we allow the <code>scriptPubKey</code>
below in the <code>IsStandard</code> check:</p>
<pre>
 OP_DUP OP_HASH160 &lt;<em>pubkeyhash</em>&gt; OP_EQUALVERIFY OP_CHECKSIGVERIFY
 &lt;<em>sidechainId</em>&gt; OP_STAKEVERIFY
</pre>
<p>Where <em>sidechainId</em> is a non-zero identifier for a
sidechain, and <em>pubkeyhash</em> is the hash of a public key
that the staker controls.</p>
<p>The stake may be spent in one of two ways.  Given the
<code>scriptSig</code> below, the stake is simply spent, i.e.
it is removed from being staked to the given sidechain.</p>
<pre>
 0 &lt;<em>signature</em>&gt; &lt;<em>pubkey</em>&gt;
</pre>
<p>The other way is used to publish a sidechain block header
specifically for the particular sidechain it is staked for:</p>
<pre>
 1 &lt;<em>signature</em>&gt; &lt;<em>pubkey</em>&gt;
</pre>
<p>In the latter case, the transaction spending the stake
UTXO has additional restrictions:</p>
<ol>
 <li>It is valid only if the UTXO is the stake winner from
     the previous block header hash.</li>
 <li>The transaction's 0-indexed output must be an <code>OP_RETURN</code>
     output that contains a sidechain block header.  The sidechain
     block header's <code>hashPrevBlock</code> must be either
     0, or the hash of a sidechain block header of that sidechain
     that was already published before.</li>
</ol>
<p>Since publication of a sidechain block header requires a spend
of the stake, this ensures that a mainstaker can only publish a
single sidechain block header if it wins the stake lottery.</p>
<p>The transaction needs to pay to mainchain miners in order to
be mined; thus mainchain miners are bribed to include the sidechain
block header by being offered fees in the transaction.</p>
<p>If the staker wants to continue staking on the same sidechain,
it can decide to put the remaining funds into a new stake UTXO on
the same transaction.</p>

<h1>Security</h1>
<p>Sidechain security is based on the assumption that no single
large maincoin owner can exist that dominates over other maincoin
owners.</p>
<p>We can compare mainstaked sidechains to the mined mainchain:</p>
<ul>
 <li>A miner of the mainchain is similar to a mainstaker of the
     sidechain.</li>
 <li>A mainchain miner invests some resources outside of the
     mainchain to purchase or create mining hardware to build the
     mainchain.  A sidechain mainstaker invests some resources
     outside of the sidechain (maincoin) to build the sidechain.</li>
 <li>A mainchain miner spends electricity, effectively turning it
     into maincoin.  A sidechain mainstaker spends the opportunity
     cost of the hodling (it could have been invested in JoinMarket
     or Lightning Network payment node, for example), effectively
     turning the opportunity cost into sidecoin fees.</li>
 <li>In general, the larger the mainchain miner's investment in
     hashpower, the more likely to mine a block and the greater
     the reward.  In general, the larger the sidechain mainstaker's
     investment in stake, the more likely to win the stake lottery
     and the greater the reward.</li>
</ul>
<p>Similarly, for a given sidechain, if a mainstaker has &gt;50% of
the stake, then it would be possible for the mainstaker to attack
the sidechain.  However, for the sidechain, the consequences of a
successful 51% attack is greater: the loss of the entire maincoin
backing the sidecoin.</p>
<p>The difference is that we expect a successful 51% attack to be
much more difficult for sidechain mainstakers to pull off.  We
point out that while today a very small fraction of Bitcoin users
currently operate mining hardware, by definition a Bitcoin user
must at some point "own" some bitcoins.
This is the basis for our consideration that, with mainstaking,
it is less likely that a large amount of maincoin will be
controlled by a small number of mainstakers, compared to the
likelihood that a large amount of mining hashpower will be
operated by a small number of miners.</p>
<h2>Level-crossing Attacks</h2>
<p>But we should note that while sidechain mainstaking is a
virtual mainchain mining, the virtualization itself is dependent
on the mainchain operation.  We should also consider what mainchain
miners can do to attack or otherwise damage the sidechains dependent
upon the mainchain, regardless of what reasons we may imagine they
have to attack or not attack.</p>
<p>Mainchain miners can't usefully affect who is selected as stake
winners or unstake existing mainstakers.  However, they can filter
out winning mainstakers from publishing sidechain headers.
This will work as well as any miner transaction
blacklisting policy: if the blacklisting miner has
&lt;50% of the mining hashpower, then it is likely some other miner
will accept and publish it anyway, with the blacklisting miner
unable to impose its will without risk loss of earnings.</p>
<p>It is useful to compare the situation where less than 50% of
miners want to somehow attack sidechains, for any reason, under
drivechains.  Under drivechains, a 26% cartel can block all
withdrawals indefinitely (if the proposed parameter X=504, but
reducing X will then let a &lt;50% cartel to steal sidechain
funds), whereas under mainstake, a 26% cartel can
only slow down sidechain operation, with withdrawals still able to
get through.</p>
<p>On the other hand, if the attacking miner controls &gt;50%
mining hashpower, the attacking miner can impose the policy
that any sidechain block header it does not publish itself cannot
be published.  This allows the attacking miner to steal the
entire sidechain coins: it will publish an invalid withdrawal, then
push a longer chain sufficient to validate the withdrawal.  But we
offer a weak mitigation: if the sidechain has sufficient mainstake
that is not controlled by the miner, then the miner has low probability
of being able to extend its desired invalid chain no matter its
hashpower, while still able to stifle extension of the valid chain.
This will slow down the miner's attack, hopefully enough that
other miners can rescue the ecosystem, or a proof-of-work change
can be deployed.</p>
<p>In case of multiple sidechains, the miner must either split up its
maincoin across the sidechains and attack each sidechain
simultaneously, but suffer a low probability of being able to publish
an invalid block for each and slowing down the attack, or focus its
attention on one sidechain at a time.
This is a minor improvement over drivechain, where a
&gt;50% coalition can costlessly steal all sidechains
simultaneously.</p>
<h2>Centralization Risk</h2>
<p>Drivechain has significant incentive for a sidechain protector
and a mainchain miner to coalesce, increasing centralization risk.</p>
<ul>
 <li>A mainchain miner needs to know the validity of every withdrawal
     transaction in order to determine the correct way to vote.</li>
 <li>A sidechain protector wants to be reassured that it will be
     able to withdraw from the sidechain, and will want to have a
     special relationship with mainchain miners to give them accurate
     information on how to vote for the sidechain withdrawals.</li>
</ul>
<p>Drivechain's "blind" merge mining does not help, as it only
provides the hash to publish, and not voting information.</p>
<p>Further, while drivechain assumes that miners will always upvote
each withdrawal, and only downvote if an invalid withdrawal
"slips through", this behavior can be attacked by spamming invalid
withdrawals continuously.  The only mitigation offered is for
miners to "temporarily" upgrade to sidechain fullnodes; but one
wonders if there is sufficient incentive to downgrade.
This essentially seems to admit of only one true solution: merge
sidechain protectors and mainchain miners, then forcibly softfork in
the sidechain into an extension block.</p>
<p>Mainstaking, on the other hand, limits miner control over
sidechains.  A sidechain mainstaker wants to be able to publish
its transaction to all miners immediately before the next block
is found (since its sidechain header is valid only on the block
after it wins the stake lottery), but assuming that
"fast" mainchain blocks are rare, the normal flooding process
will be fast enough for this.</p>
<p>The expected default behavior of mainstaking is that miners will,
as usual, get as many high-value valid transactions into blocks,
without attempting to censor or block certain transactions.  In this
case, mainstakers can operate the sidechain continuously without
requiring special relationships with mainchain miners, unlike
drivechain, which requires that a sidechain protector have special
trusted channels to transmit voting information to mainchain miners.</p>

<h1>Stake Timeout</h1>
<p>For various reasons, it may be best to consider having staked
UTXOs time out.  That is, the stake lottery will only include
mainstake UTXOs up to, say, 12096 mainchain blocks ago.  Mainstakers
must renew their UTXOs by doing a "normal" spend using <code>0
&lt;signature&gt; &lt;pubkey&gt;</code> and spending it again on a
new stake <code>scriptPubKey</code>.</p>
<ul>
 <li>In case the private keys of a mainstake are lost or destroyed
     (for example, physical destruction of the hardware executing
     the sidechain mainstaker code), if that particular mainstake
     wins the stake lottery, then the sidechain cannot advance for
     that mainchain block.  However, after enough time has passed,
     the mainstake is removed from the stake lottery and will no
     longer encumber the sidechain.</li>
 <li>This policy subtly encourages mainstakers to put all of their
     stake in a single UTXO.  When a mainstaker wins the stake
     lottery, it spends the winning UTXO and creates a new stake
     UTXO, which basically resets the timeout of the stake.  If
     the mainstaker put all the stake in one UTXO, then the entire
     stake is refreshed.  If the mainstaker put the stake in two
     UTXO, however, then only one stake is refreshed, and the other
     has a chance not to win until it times out.  Reducing the
     number of UTXOs is always a win.</li>
 <li>It allows the sidechain to be upgraded from a mainstaked
     sidechain to a miner-controlled, mainchain fullnode-verified
     extension block (see next section).</li>
</ul>
<p>Against those, however, we must caution the below:</p>
<ul>
 <li>Our weak mitigation against a mainchain miner &gt;50% attack
     is weakened further; now the mainchain miner with 51% hashpower
     need only block the creation of sidechain mainstake UTXOs except
     its own, and eventually the other mainstake UTXOs will time out
     and the miner can outright steal costlessly.  The miner can
     even just wait out the timeout period and steal all sidechain
     coins as soon as all the timeouts end.  Hopefully such dire
     straits will allow a PoW change to be deployed in 3 months.</li>
 <li>This rewards hodlers with larger hodlings slightly more than
     those with smaller hodlings.  A larger mainstake UTXO is more
     likely to win the stake lottery, which gets the renewal "for free",
     while a smaller mainstake UTXO will have to pay miners to renew
     the UTXO.</li>
</ul>

<h1>Upgrading Mainstaked Sidechains to Miner-Controlled Extension
Blocks</h1>
<p>The end goal for any sidechain is to be merged into mainchain as
an extension block.</p>
<p>If mainstakes will time out, then the below upgrade path can be
used.</p>
<ol>
 <li>The developer selects a public-private keypair and publishes both
     private and public keys.  This will be the miner-controlled
     keypair.</li>
 <li>At ACTIVATE, mainchain fullnodes will now verify the sidechain
     blocks and reject invalid sidechain blocks.</li>
 <li>After ACTIVATE, the developer creates a single UTXO with 1
     satoshi, staked to the sidechain (now an extension block) with
     the published public key.
     This is the current miner-controlled stake.  Spends of this
     stake is only allowed if it is publishing a sidechain block
     header, or if it will spend itself entirely on a new
     miner-controlled stake.</li>
 <li>After ACTIVATE, new mainstaking UTXOs are disallowed, other
     than the miner-controlled stake.</li>
 <li>When all other mainstake UTXOs have timed out or have been
     unstaked, only the miner-controlled stake will be selected
     in the stake lottery, even at 1 satoshi.  The sidechain is
     now completely a miner-controlled extension block.</li>
</ol>

</div>

<div class=footer>
<p>&copy; 2017 ZmnSCPxj.  Released under CC-BY.</p>
</div>

</body>
</html>
